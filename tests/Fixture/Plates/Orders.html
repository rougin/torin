<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Torin - Simple inventory management.</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/css/tom-select.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/css/tom-select.bootstrap5.min.css">
  <style type="text/css">
    html, body { font-family: 'Roboto'; }
    .ex-pointer { cursor: pointer; }
  </style>
</head>
<body style="background: #ebebeb;">
    <div x-data="orders" @orders.window="load($event.detail)">
    <div class="mb-3">
      <div class="navbar py-0 navbar-expand-lg bg-black shadow-lg" data-bs-theme="dark">
  <div class="container py-3">
    <span class="navbar-brand mb-1 h1">Torin</span>
    <div class="collapse navbar-collapse d-flex" id="navbarNav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item">
                      <a class="nav-link" href="http://localhost/">Home</a>
                  </li>
        <li class="nav-item">
                      <div class="nav-link active fw-bold">Orders</div>
                  </li>
        <li class="nav-item">
                      <a class="nav-link" href="http://localhost/clients">Clients</a>
                  </li>
        <li class="nav-item">
                      <a class="nav-link" href="http://localhost/items">Items</a>
                  </li>
      </ul>
    </div>
  </div>
</div>
    </div>

    <div class="container mb-3">
      <div class="d-flex justify-content-between align-items-end">
        <div>
          <span class="fs-2 lh-1 fw-bold">Orders</span>
        </div>
        <div>
          <button type="button" class="btn btn-secondary shadow-lg" data-bs-toggle="modal" data-bs-target="#order-detail-modal" :disabled="loading">Create New</button>        </div>
      </div>
      <div class="text-secondary">
        <hr>
      </div>
    </div>

    <div class="container mb-3">
      <div class="card shadow-lg">
        <div class="card-body">
          <div><table class="table mb-0" :class="{ 'opacity-50': items.length > 0 && loading}"><thead><tr><th align="left" width="5%">Type</th><th align="left" width="5%">Status</th><th align="left" width="13%">Order Code</th><th align="left">Client Name</th><th align="left">Remarks</th><th align="left" width="14%">Created At</th><th align="left" width="14%">Updated At</th><th align="left" width="5%"></th></tr></thead><tbody><template x-if="items.length === 0 && loading"><template x-data="{ length: items && items.length ? items.length : 5 }" x-for="i in length"><tr><td class="align-middle placeholder-glow"><span class="placeholder col-12"></span></td><td class="align-middle placeholder-glow"><span class="placeholder col-12"></span></td><td class="align-middle placeholder-glow"><span class="placeholder col-12"></span></td><td class="align-middle placeholder-glow"><span class="placeholder col-12"></span></td><td class="align-middle placeholder-glow"><span class="placeholder col-12"></span></td><td class="align-middle placeholder-glow"><span class="placeholder col-12"></span></td><td class="align-middle placeholder-glow"><span class="placeholder col-12"></span></td><td class="align-middle placeholder-glow"><span class="placeholder col-12"></span></td></tr></template></template><template x-if="items.length === 0 && empty"><tr><td colspan="8" class="align-middle text-center"><span>No orders found.</span></td></tr></template><template x-if="! loading && loadError"><tr><td colspan="8" class="align-middle text-center"><span>An error occured in getting the orders.</span></td></tr></template><template x-if="items && items.length > 0"><template x-for="item in items"><tr><td><template x-if="item.type === TYPE_PURCHASE"><span class="badge rounded-pill text-uppercase text-bg-primary">Purchase</span></template><template x-if="item.type === TYPE_SALE"><span class="badge rounded-pill text-uppercase text-bg-success">Sales</span></template><template x-if="item.type === TYPE_TRANSFER"><span class="badge rounded-pill text-uppercase text-bg-secondary">Transfer</span></template></td><td><template x-if="item.status === STATUS_CANCELLED"><span class="badge rounded-pill text-uppercase text-bg-danger">Cancelled</span></template><template x-if="item.status === STATUS_COMPLETED"><span class="badge rounded-pill text-uppercase text-bg-success">Fulfilled</span></template><template x-if="item.status === STATUS_PENDING"><span class="badge rounded-pill text-uppercase text-bg-warning">Pending</span></template></td><td x-text="item.code"></td><td x-text="item.client.name"></td><td x-text="item.remarks"></td><td x-text="item.created_at"></td><td x-text="item.updated_at"></td><td><div class="dropdown"><button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">Actions</button><div class="dropdown-menu dropdown-menu-end"><div><a class="dropdown-item" href="javascript:void(0)" @click="mark(item, STATUS_COMPLETED)">Mark as Complete</a></div><div><a class="dropdown-item" href="javascript:void(0)" @click="edit(item)">Update</a></div><div><hr class="dropdown-divider"></div><div><a class="dropdown-item text-danger" href="javascript:void(0)" @click="trash(item)">Delete</a></div></div></div></td></tr></template></template></tbody></table></div>
        </div>
      </div>
      <div class="mt-3">
        <div class="d-inline-block"><ul class="pagination"><li class="page-item" :class="{ 'disabled': pagee.page === 1 }"><a class="page-link" :href="pagee.url(1)" :page="1" @click.prevent="pagee.view($dispatch, $el)">First</a></li><li class="page-item" :class="{ 'disabled': pagee.page <= 1 }"><a class="page-link" :href="pagee.url(pagee.page - 1)" :page="pagee.page - 1" @click.prevent="pagee.view($dispatch, $el)">Prev</a></li><template x-for="(page, index) in pagee.items()" :key="index"><li class="page-item" :class="{ 'active': (index + 1) === pagee.page }"><a class="page-link" :href="pagee.url(index + 1)" :page="index + 1" @click.prevent="pagee.view($dispatch, $el)" x-text="index + 1"></a></li></template><li class="page-item" :class="{ 'disabled': pagee.page >= pagee.pages }"><a class="page-link" :href="pagee.url(pagee.page + 1)" :page="pagee.page + 1" @click.prevent="pagee.view($dispatch, $el)">Next</a></li><li class="page-item" :class="{ 'disabled': pagee.page === pagee.pages }"><a class="page-link" :href="pagee.url(pagee.pages)" :page="pagee.pages" @click.prevent="pagee.view($dispatch, $el)">Last</a></li></ul></div>      </div>
    </div>

    <div class="modal fade" id="delete-order-modal" data-bs-backdrop="static" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
  <div class="modal-content">
    <div class="modal-header text-white bg-danger border-bottom-0">
      <div class="modal-title fs-5 fw-bold" id="order-detail-modal-label">Delete order?</div>
    </div>
    <div class="modal-body">
      <p class="mb-0">Are you sure that you want to delete the order <span class="fw-bold" x-text="code"></span>?</p>
      <template x-if="error.delete"><p class="text-danger small mb-0" x-text="error.delete[0]"></p></template>    </div>
    <div class="modal-footer border-top-0 bg-light">
      <div class="me-auto">
        <div class="spinner-border align-middle text-danger" role="status" x-show="loading">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <button type="button" class="btn btn-link text-secondary text-decoration-none" @click="close" :disabled="loading">Cancel</button>      <button type="button" class="btn btn-danger" @click="remove(id)" :disabled="loading">Delete</button>    </div>
  </div>
</div>
</div>
    <div class="modal fade" id="order-detail-modal" data-bs-backdrop="static" tabindex="-1">
<div class="modal-dialog modal-dialog-centered modal-scrollable">
  <div class="modal-content">
    <div class="modal-header text-white border-bottom-0" :class="{ 'bg-primary': id, 'bg-secondary': !id }">
      <template x-if="id">
        <div class="modal-title fs-5 fw-bold" id="order-detail-modal-label">Update Order</div>
      </template>
      <template x-if="! id">
        <div class="modal-title fs-5 fw-bold" id="order-detail-modal-label">Create New Order</div>
      </template>
    </div>
    <div class="modal-body">
      <div class="row mb-3">
        <div class="col-sm-8">
          <label class="form-label mb-0">Client Name <span class="text-danger">*</span></label>          <select name="client_id" class="form-select" id="clients" x-model="client_id" :disabled="loading"><option value="">Please select</option></select>          <template x-if="error.client_id"><p class="text-danger small mb-0" x-text="error.client_id[0]"></p></template>        </div>
        <div class="col-sm-4">
          <label class="form-label mb-0">Order Type <span class="text-danger">*</span></label>          <select name="type" class="form-select" id="type" x-model="type" :disabled="loading"><option value="">Please select</option><option value="0">Sale</option><option value="1">Purchase</option><option value="2">Transfer</option></select>          <template x-if="error.type"><p class="text-danger small mb-0" x-text="error.type[0]"></p></template>        </div>
      </div>
      <div class="card mb-3">
        <div class="card-body">
          <div>
            <div class="row align-items-end">
              <div class="col-sm-7">
                <label class="form-label mb-0 small">Item to add</label>                <select name="item_id" class="form-select" id="items" x-model="item_id" :disabled="loading"><option value="">Please select</option></select>              </div>
              <div class="col-sm-3">
                <label class="form-label mb-0 small">Quantity</label>                <input type="number" name="quantity" class="form-control" x-model="quantity" :disabled="loading">              </div>
              <div class="col-sm-2 align-self-end">
                <button type="button" class="btn btn-secondary" @click="add" :disabled="loading || ! item_id || ! quantity">Add</button>              </div>
            </div>
          </div>
          <div class="mb-3">
            <template x-if="error.item_id"><p class="text-danger small mb-0" x-text="error.item_id"></p></template>          </div>
          <div>
            <table class="table mb-0">
              <thead>
                <tr class="fw-bold small">
                  <td width="80%">Item Name</td>
                  <td width="20%">Quantity</td>
                  <td></td>
                </tr>
              </thead>
              <tbody>
                <template x-if="cart.length === 0">
                  <tr>
                    <td colspan="3" class="text-center small">No items added.</td>
                  </tr>
                </template>
                <template x-if="cart.length > 0">
                  <template x-for="(item, index) in cart">
                    <tr>
                      <td x-text="item.name"></td>
                      <td x-text="item.quantity"></td>
                      <td>
                        <button type="button" class="btn-close" @click="cart.splice(index, 1)"></button>
                      </td>
                    </tr>
                  </template>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <label class="form-label mb-0">Remarks</label>          <input type="text" name="remarks" class="form-control" x-model="remarks" :disabled="loading">          <template x-if="error.remarks"><p class="text-danger small mb-0" x-text="error.remarks[0]"></p></template>        </div>
      </div>
    </div>
    <div class="modal-footer border-top-0 bg-light">
      <div class="me-auto">
        <div class="spinner-border align-middle" :class="{ 'text-primary': id, 'text-secondary': !id }" role="status" x-show="loading">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <button type="button" class="btn btn-link text-secondary text-decoration-none" @click="close" :disabled="loading">Cancel</button>      <template x-if="id">
        <button type="button" class="btn btn-primary" @click="update(id)" :disabled="loading">Update</button>      </template>
      <template x-if="! id">
        <button type="button" class="btn btn-secondary" @click="store" :disabled="loading">Create New</button>      </template>
    </div>
  </div>
</div>
</div>
    <div class="modal fade" id="mark-order-modal" data-bs-backdrop="static" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
  <div class="modal-content">
    <div class="modal-header bg-warning border-bottom-0">
      <div class="modal-title fs-5 fw-bold" id="order-detail-modal-label">Change order status?</div>
    </div>
    <div class="modal-body">
      <p class="mb-0">Are you sure that you want to change the order status to <span class="fw-bold text-uppercase" x-text="status === STATUS_COMPLETED ? 'Fulfilled' : (status === STATUS_CANCELLED ? 'Cancelled' : 'Pending')"></span>?</p>
      <template x-if="error.mark"><p class="text-danger small mb-0" x-text="error.mark[0]"></p></template>    </div>
    <div class="modal-footer border-top-0 bg-light">
      <div class="me-auto">
        <div class="spinner-border align-middle text-warning" role="status" x-show="loading">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <button type="button" class="btn btn-link text-secondary text-decoration-none" @click="close" :disabled="loading">Cancel</button>      <button type="button" class="btn btn-warning" @click="change(id, status)" :disabled="loading">Change Status</button>    </div>
  </div>
</div>
</div>
  </div>

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.6/dist/cdn.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script type="text/javascript">const Modal={get(t){const e=document.getElementById(t);return bootstrap.Modal.getOrCreateInstance(e)},hide(t){return this.get(t).hide()},show(t){return this.get(t).show()},toggle(t){return this.get(t).toggle()}};</script>
  <div class="modal fade" id="cuel-alert-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div id="cuel-alert-modal-header"><span class="modal-title fs-5 fw-bold" id="cuel-alert-modal-title"></span></div><div class="modal-body" id="cuel-alert-modal-body"></div><div class="modal-footer border-top-0 bg-light"><div class="me-auto"></div><button type="button" class="btn btn-link text-secondary text-decoration-none" data-bs-dismiss="modal">Close</button></div></div></div></div>

<script type="text/javascript">const Alert={danger(e,t){return this.show(e,t,"bg-danger text-white")},info(e,t){return this.show(e,t,"bg-info text-white")},primary(e,t){return this.show(e,t,"bg-primary text-white")},secondary(e,t){return this.show(e,t,"bg-secondary text-white")},show(e,t,r){const n="cuel-alert-modal";document.getElementById(n+"-header").className="modal-header border-bottom-0 "+r;document.getElementById(n+"-title").innerHTML=e;document.getElementById(n+"-body").innerHTML=t,Modal.show("cuel-alert-modal")},success(e,t){return this.show(e,t,"bg-success text-white")},warning(e,t){return this.show(e,t,"bg-warning")}};</script>

    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/js/tom-select.complete.min.js"></script>
  <script type="text/javascript">
let orders = {"STATUS_CANCELLED":2,"STATUS_PENDING":0,"STATUS_COMPLETED":1,"TYPE_SALE":0,"TYPE_PURCHASE":1,"TYPE_TRANSFER":2,"client_id":null,"type":null,"remarks":null,"items":[],"empty":false,"loadError":false,"id":null,"delete":false,"item_id":null,"quantity":null,"cart":[],"code":null,"status":null,"error":{},"loading":false};
orders.pagee={limit:10,limitKey:"l",link:"http://localhost/orders",dispatchKey:"orders",page:"1",pageKey:"p",pages:0,total:0,items:function(){if(0===this.pages){const t=this.total/this.limit;this.pages=Math.ceil(t)}return Array.from({length:this.pages})},url:function(t){return this.link+"?"+this.pageKey+"="+t+"&"+this.limitKey+"="+this.limit},view:function(t,i){const e=parseInt(i.getAttribute("page"));e!==this.page&&(history.pushState({},"",i.href),t(this.dispatchKey,e))}}
orders.init=function(){this.ts_clients=new TomSelect('#clients',{create:false,plugins:['dropdown_input'],labelField:'label',searchField:'label',sortField:'label',valueField:'value',preload:true,load:function(query,cb){const url='http://localhost/v1/clients/select';fetch(url).then(response=>response.json()).then(json=>cb(json)).catch(()=>{cb()});}});this.ts_items=new TomSelect('#items',{create:false,plugins:['dropdown_input'],labelField:'label',searchField:'label',sortField:'label',valueField:'value',preload:true,load:function(query,cb){const url='http://localhost/v1/items/select';fetch(url).then(response=>response.json()).then(json=>cb(json)).catch(()=>{cb()});}});this.load(1);};
orders.close=function(){const self=this;Modal.hide('delete-order-modal');Modal.hide('mark-order-modal');Modal.hide('order-detail-modal');setTimeout(()=>{self.client_id=null;self.error={};self.id=null;self.remarks=null;self.loadError=false;},1000)};
orders.load=function(page){const self=this;self.loading=true;let data={p:page};self.pagee.page=page;data.l=10;const search=new URLSearchParams(data);axios.get('http://localhost/v1/orders'+'?'+search.toString()).then(function(response){const result=response.data;if(result.items.length===0){self.empty=true;}self.pagee.limit=result.limit;self.pagee.pages=result.pages;self.pagee.total=result.total;self.items=result.items;}).catch(function(error){self.loadError=true;}).finally(function(){self.loading=false;})};
orders.mark=function(item,status){const self=this;self.status=status;self.id=item.id;Modal.show('mark-order-modal');};
orders.remove=function(id){const input=new FormData;const self=this;self.loading=true;self.error={};axios.delete('http://localhost/v1/orders'+'/'+id,input).then(function(response){self.close();Alert.success('Item deleted!','Item successfully deleted.');self.load(self.pagee.page);}).catch(function(error){self.error=error.response.data;}).finally(function(){self.loading=false;});};
orders.store=function(){const input=new FormData;const self=this;input.append('client_id',self.client_id);input.append('remarks',self.remarks);input.append('type',self.type);self.cart.forEach(function(item,index){if(!(item instanceof Object)){input.append('cart['+index+']',item);return;}Object.keys(item).forEach(function(key){input.append('cart['+index+']['+key+']',item[key]);});});self.loading=true;self.error={};axios.post('http://localhost/v1/orders',input).then(function(response){self.close();Alert.success('Client created!','Client successfully created.');self.load(self.pagee.page);}).catch(function(error){self.error=error.response.data;}).finally(function(){self.loading=false;});};
orders.trash=function(item){const self=this;self.code=item.code;self.id=item.id;Modal.show('delete-order-modal');};
orders.add = function ()
{
  const opt = this.ts_items.getOption(this.item_id);

  if (! opt) return;

  let row = { id: parseInt(this.item_id) };
  row.name = opt.textContent;
  row.quantity = parseInt(this.quantity);

  let last = null;

  this.cart.forEach(function (item, index)
  {
    if (item.id === row.id)
    {
      last = index;
    }
  });

  this.loading = true;

  this.error = {};

  const data = new FormData;

  data.append('type', this.type);
  data.append('quantity', row.quantity);
  data.append('item_id', row.id);

  const self = this;

  axios.post('/v1/orders/check', data)
    .then(function ()
    {
      if (last === null)
      {
        self.cart.push(row);

        last = 0;
      }

      self.cart[last].quantity += row.quantity;

      self.ts_items.clear();

      self.quantity = null;
    })
    .catch(function (error)
    {
      self.error.item_id = error.response.data;
    })
    .finally(function ()
    {
      self.loading = false;
    });
};

orders.change = function(id, status)
{
  const self = this;

  this.loading = true;
  this.error = {};

  const data = new FormData();
  data.append('status', status);

  axios.post('/v1/orders/' + id + '/status', data)
    .then(function()
    {
      const text = 'The status of the order has been sucessfully updated.';

      self.close();

      Alert.success('Order status changed!', text);

      self.load();
    })
    .catch(function (error)
    {
      self.error.mark = error.response.data;
    })
    .finally(function()
    {
      self.loading = false;
    });
};
</script>
</body>
</html>



